<html>
<head>
<title>Simple Shift Plot</title>
<!-- <script src="d3/d3.js" charset="utf-8"></script> -->
<script src="static/d3.andy2.js" charset="utf-8"></script>
<script src="static/plotShiftChaptersFourBars.js" charset="utf-8"></script>
<script src="static/shift-foreign.js" charset="utf-8"></script>
<script src="static/drawLens-chapters.js" charset="utf-8"></script>
<script src="static/selectChapter.js" charset="utf-8"></script>
<script src="static/selectChapterTop.js" charset="utf-8"></script>
<script src="static/drawBookTimeseries.js" charset="utf-8"></script>
<script src="static/computeHappsChapters.js" charset="utf-8"></script>
  <style>
    body {
      font-family: Verdana,Arial,sans-serif;
    }

    h4 {
    font-size: .8em;
    margin: 60px 0 5px 0;
    }

    h5 {
    font-size: .8em;
    margin: 10px 0 5px 0;
    }

    body {
    min-width: 650px;
    }

    #caption01 {
      width: 500px;
    }

    #lens01 {
      width: 600px;
    }

    #figure01 {
      width: 600px;
    }

    .domain {
      fill: none;
      stroke: black;
      stroke-width: 2;
     }

  </style>
</head>
<body>

<div id="header"></div>
<!-- <h4>Select the reference: <select id="refSelect"><option value="none">none</option></select> Select the comparison: <select id="compSelect"><option value="none">none</option></select></h4> -->
<center>

<div id="caption01">
Move the stop-window to remove words from the lense.
Removing 4 though 6, the default, corresponds to the tuned hedonometer for large corpuses.</div>
<br>

<div id="lens01" class="figure"></div>

<br>

<div id="chapters01" class="figure"></div>
<div id="chapters03" class="figure"></div>
<div id="chapters02" class="figure"></div>
<br>
<br>

Click on the graph and drag up to reveal additional words.
<br>


<div id="figure01" class="figure"></div>

</center>

<div id="footer"></div>

<script>
function initializePlot() {
    loadCsv();
}

function loadCsv() {
var csvLoadsRemaining = 4;
d3.text("data/moby_dick_freq_all.csv", function(text) {
    tmp = text.split("\n");
    // kill extra rows
    var len = tmp.length-1;
    //while (!tmp[len]) { console.log("in while loop"); tmp = tmp.slice(0,len); len--; } 
    // build the full data, terrible
    allDataRaw = Array(tmp[0].split(',').length);
    //allData = Array(tmp[0].split(',').length);
    for (var i = 0; i<tmp[0].split(',').length; i++) { 
allDataRaw[i] = Array(tmp.length); 
//allData[i] = Array(tmp.length);
 }
    for (var i = 0; i<tmp.length; i++) {
        var tmpTmp = tmp[i].split(',');
	for (var j = 0; j<tmpTmp.length; j++) {
        allDataRaw[j][i] = parseFloat(tmpTmp[j]);
 }}
    console.log(d3.sum(allDataRaw[0]));
    if (!--csvLoadsRemaining) initializePlotPlot(allDataRaw,lens,words);
});
d3.text("data/labMTvec.csv", function(text) {
    var tmp = text.split("\n");
    //console.log(tmp.length);
    //console.log(tmp[tmp.length-1]);
    lens = tmp.map(parseFloat);
    var len = lens.length-1;
    while (!lens[len]) { console.log("in while loop"); lens = lens.slice(0,len); len--; } 
    if (!--csvLoadsRemaining) initializePlotPlot(allDataRaw,lens,words);
});
d3.text("data/labMTwords.csv", function(text) {
    var tmp = text.split("\n");
    words = tmp;
    var len = words.length-1;
    while (!words[len]) { console.log("in while loop"); words = words.slice(0,len); len--; } 
    if (!--csvLoadsRemaining) initializePlotPlot(allDataRaw,lens,words);
});
d3.text("data/labMTwords.csv", function(text) {
    var tmp = text.split("\n");
    words_en = tmp;
    var len = words_en.length-1;
    while (!words_en[len]) { console.log("in while loop"); words_en = words_en.slice(0,len); len--; } 
    if (!--csvLoadsRemaining) initializePlotPlot(allDataRaw,lens,words);
});
};

function initializePlotPlot(allDataRaw,lens,words) {
    // initially apply the lens
    var minSize = 10000;
    var dataSize = 1000;
    minWindows = Math.round(minSize/dataSize);

    // load variables from the URL					 
    GET = {};
    query = window.location.search.substring(1).split("&");
    for (var i = 0, max = query.length; i < max; i++)
    {
        if (query[i] === "") // check for trailing & with no param
            continue;
        var param = query[i].split("=");
        GET[decodeURIComponent(param[0])] = decodeURIComponent(param[1] || "");
    }					 

    if ("lens" in GET) {
        var tmpArray = GET["lens"].substring(1,GET["lens"].length-1).split(',').map(parseFloat);
    lensExtent = tmpArray;
}
else {					    
    lensExtent = [4,6];
}


    ignoreWords = ["cried","cry","coffin"];				  
    refFextent = [0,Math.round(allDataRaw.length*.15)];
    compFextent = [Math.round(allDataRaw.length*.85),allDataRaw.length];
	// initialize new values
	var refF = Array(allDataRaw[0].length);
	var compF = Array(allDataRaw[0].length);
	allData = Array(allDataRaw.length);
	// fill them with 0's
	for (var i=0; i<allDataRaw[0].length; i++) {
            refF[i]= 0;
            compF[i]= 0;
	}
	for (var i=0; i<allDataRaw.length; i++) {
	    allData[i] = Array(allDataRaw[i].length);
	}
	// loop over each slice of data
	for (var i=0; i<allDataRaw[0].length; i++) {
	    var include = true;
	    for (var k=0; k<ignoreWords.length; k++) {
		if (ignoreWords[k] == words[i]) {
		    include = false;
		}
	    }
	    if (lens[i] > lensExtent[0] && lens[i] < lensExtent[1]) {
		include = false;
	    }
	    // grab the shift vectors
	    if (include) {
		for (var k=refFextent[0]; k<refFextent[1]; k++) {
                    refF[i] += parseFloat(allDataRaw[k][i]);
		}
		for (var k=compFextent[0]; k<compFextent[1]; k++) {
                    compF[i] += parseFloat(allDataRaw[k][i]);
		}
		for (var k=0; k<allDataRaw.length; k++) {
		    allData[k][i] = allDataRaw[k][i];
		}
	    }
	    // slice up the data
	    // for quicker redraw on window selection
	    // and happiness calculation
	    // double overhead for storage
             else { 
	     	for (var k=0; k<allData.length; k++) { allData[k][i] = 0; }
	     }
	}

    drawLens(d3.select("#lens01"),lens);
    timeseries = computeHapps();				    
    selectChapterTop(d3.select("#chapters01"),allDataRaw.length);
    console.log(timeseries);
    drawBookTimeseries(d3.select("#chapters03"),timeseries);
    selectChapter(d3.select("#chapters02"),allDataRaw.length);

    shiftObj = shift(refF,compF,lens,words);
    plotShift(d3.select("#figure01"),shiftObj.sortedMag.slice(0,200),
              shiftObj.sortedType.slice(0,200),
              shiftObj.sortedWords.slice(0,200),
              shiftObj.sortedWordsEn.slice(0,200),
              shiftObj.sumTypes,
              shiftObj.refH,
              shiftObj.compH);

};

initializePlot();

</script>
  <!-- <style> -->
  <!--   .domain { -->
  <!--     stroke-width: 0.5; -->
  <!--    } -->

  <!-- </style> -->

</body>
</html>


